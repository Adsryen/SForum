(function(){"use strict";var e,a,c,l,u,f=tinymce.util.Tools.resolve("tinymce.PluginManager");const C=(e,t,n)=>{var s;return!!n(e,t.prototype)||((s=e.constructor)===null||s===void 0?void 0:s.name)===t.name},O=e=>{const t=typeof e;return e===null?"null":t==="object"&&Array.isArray(e)?"array":t==="object"&&C(e,String,(e,t)=>t.isPrototypeOf(e))?"string":t},w=e=>t=>O(t)===e,m=e=>t=>e===t,x=w("string"),z=m(void 0);c=tinymce.util.Tools.resolve("tinymce.util.Delay"),e=tinymce.util.Tools.resolve("tinymce.util.LocalStorage"),a=tinymce.util.Tools.resolve("tinymce.util.Tools");const F=e=>e.dispatch("RestoreDraft"),S=e=>e.dispatch("StoreDraft"),_=e=>e.dispatch("RemoveDraft"),y=e=>{const n={s:1e3,m:6e4},t=/^(\d+)([ms]?)$/.exec(e);return(t&&t[2]?n[t[2]]:1)*parseInt(e,10)},s=e=>t=>t.options.get(e),p=e=>{const t=e.options.register,n=e=>{const t=x(e);return t?{value:y(e),valid:t}:{valid:!1,message:"Must be a string."}};t("autosave_ask_before_unload",{processor:"boolean",default:!0}),t("autosave_prefix",{processor:"string",default:"tinymce-autosave-{path}{query}{hash}-{id}-"}),t("autosave_restore_when_empty",{processor:"boolean",default:!1}),t("autosave_interval",{processor:n,default:"30s"}),t("autosave_retention",{processor:n,default:"20m"})},g=s("autosave_ask_before_unload"),v=s("autosave_restore_when_empty"),b=s("autosave_interval"),j=s("autosave_retention"),n=e=>{const t=document.location;return e.options.get("autosave_prefix").replace(/{path}/g,t.pathname).replace(/{query}/g,t.search).replace(/{hash}/g,t.hash).replace(/{id}/g,e.id)},h=(e,t)=>{if(z(t))return e.dom.isEmpty(e.getBody());const n=a.trim(t);if(n==="")return!0;const fragment=(new DOMParser).parseFromString(n,"text/html");return e.dom.isEmpty(fragment)},t=t=>{var s;const o=parseInt((s=e.getItem(n(t)+"time"))!==null&&s!==void 0?s:"0",10)||0;return!((new Date).getTime()-o>j(t))||(i(t,!1),!1)},i=(t,s)=>{const o=n(t);e.removeItem(o+"draft"),e.removeItem(o+"time"),s!==!1&&_(t)},r=t=>{const s=n(t);!h(t)&&t.isDirty()&&(e.setItem(s+"draft",t.getContent({format:"raw",no_events:!0})),e.setItem(s+"time",(new Date).getTime().toString()),S(t))},o=s=>{var o;const i=n(s);t(s)&&(s.setContent((o=e.getItem(i+"draft"))!==null&&o!==void 0?o:"",{format:"raw"}),F(s))},E=e=>{const t=b(e);c.setEditorInterval(e,()=>{r(e)},t)},k=e=>{e.undoManager.transact(()=>{o(e),i(e)}),e.focus()},A=e=>({hasDraft:()=>t(e),storeDraft:()=>r(e),restoreDraft:()=>o(e),removeDraft:t=>i(e,t),isEmpty:t=>h(e,t)});u=tinymce.util.Tools.resolve("tinymce.EditorManager");const M=e=>{e.editorManager.on("BeforeUnload",e=>{let t;a.each(u.get(),e=>{e.plugins.autosave&&e.plugins.autosave.storeDraft(),!t&&e.isDirty()&&g(e)&&(t=e.translate("You have unsaved changes are you sure you want to navigate away?"))}),t&&(e.preventDefault(),e.returnValue=t)})},d=e=>n=>{n.setEnabled(t(e));const s=()=>n.setEnabled(t(e));return e.on("StoreDraft RestoreDraft RemoveDraft",s),()=>e.off("StoreDraft RestoreDraft RemoveDraft",s)},T=e=>{E(e);const t=()=>{k(e)};e.ui.registry.addButton("restoredraft",{tooltip:"Restore last draft",icon:"restore-draft",onAction:t,onSetup:d(e)}),e.ui.registry.addMenuItem("restoredraft",{text:"Restore last draft",icon:"restore-draft",onAction:t,onSetup:d(e)})};l=()=>{f.add("autosave",e=>(p(e),M(e),T(e),e.on("init",()=>{v(e)&&e.dom.isEmpty(e.getBody())&&o(e)}),A(e)))},l()})()